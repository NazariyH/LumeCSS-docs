<template>
    <div class="cursor">
        <div class="cursor-circle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="doodle-cursor">
                    <path id="big-doodle"
                          d="M9.65467 8.18536L9.05774 8.45859C8.35256 8.78136 8.22519 9.72924 8.82015 10.2267L8.62326 11.6031C8.58911 11.8418 8.4866 12.0656 8.32811 12.2473L8.29711 12.2829C7.50243 13.1941 8.35581 14.5862 9.52844 14.2915C10.0428 14.1622 10.5822 14.3759 10.8685 14.8223L11.2456 15.4102C11.3794 15.6188 11.5764 15.7792 11.8078 15.8678C12.401 16.0948 13.0665 15.8031 13.3015 15.213L13.4275 14.8966C13.5529 14.5816 13.8075 14.3356 14.1265 14.221C14.5665 14.063 14.8721 13.6606 14.9063 13.1944L14.9685 12.3469C14.9851 12.1202 15.07 11.9037 15.2119 11.726C15.799 10.9907 15.2801 9.90222 14.3392 9.89534L13.3213 9.88789C12.8797 9.88466 12.4585 9.70145 12.155 9.38059L11.3331 8.51164C10.9011 8.05488 10.2263 7.92371 9.65467 8.18536Z"
                          fill="black" stroke="black"/>
                    <path id="small-doodle"
                          d="M12.3909 8.47222L12.2799 8.60182C11.8423 9.11241 11.1126 9.25825 10.5124 8.95509L9.93646 8.6642C9.32384 8.35478 8.58874 8.74039 8.4951 9.4203C8.44684 9.7707 8.21704 10.0695 7.89078 10.2062L7.69677 10.2874C6.71105 10.7002 6.55775 12.0331 7.42401 12.6589L8.61088 13.5163C8.99782 13.7958 9.23342 14.2389 9.24886 14.7159L9.2556 14.9242C9.29573 16.1644 10.7762 16.7818 11.6855 15.9376L12.262 15.2839C12.597 14.904 13.0516 14.6499 13.5507 14.5635L14.4571 14.4067C15.3813 14.2468 15.9243 13.2771 15.5777 12.4055C15.459 12.1071 15.2462 11.8554 14.9716 11.6887L14.6438 11.4897C14.1112 11.1664 13.8928 10.5038 14.1288 9.92719L14.2575 9.61276C14.6136 8.74265 13.7923 7.85243 12.8964 8.13739C12.7 8.19983 12.525 8.31578 12.3909 8.47222Z"
                          fill="black" stroke="black"/>
                    <g id="particles">
                        <ellipse id="particle-18" cx="9.82067" cy="18.4404" rx="1.1231" ry="1.15777"
                                 transform="rotate(-2.27501 9.82067 18.4404)" fill="black"/>
                        <ellipse id="particle-16" cx="19.0453" cy="11.4379" rx="0.612601" ry="0.631513"
                                 transform="rotate(-2.27501 19.0453 11.4379)" fill="black"/>
                        <ellipse id="particle-15" cx="8.72981" cy="3.84219" rx="0.408401" ry="0.421009"
                                 transform="rotate(-2.27501 8.72981 3.84219)" fill="black"/>
                        <ellipse id="particle-14" cx="13.8392" cy="3.84988" rx="0.612601" ry="0.631513"
                                 transform="rotate(-2.27501 13.8392 3.84988)" fill="black"/>
                        <ellipse id="particle-13" cx="15.6922" cy="4.1976" rx="0.408401" ry="0.421009"
                                 transform="rotate(-2.27501 15.6922 4.1976)" fill="black"/>
                        <ellipse id="particle-12" cx="19.0143" cy="13.2298" rx="0.510501" ry="0.526261"
                                 transform="rotate(-2.27501 19.0143 13.2298)" fill="black"/>
                        <ellipse id="particle-11" cx="3.9488" cy="14.671" rx="0.510501" ry="0.526261"
                                 transform="rotate(-2.27501 3.9488 14.671)" fill="black"/>
                        <ellipse id="particle-10" cx="4.55743" cy="19.7029" rx="0.510501" ry="0.526261"
                                 transform="rotate(-2.27501 4.55743 19.7029)" fill="black"/>
                        <ellipse id="particle-9" cx="6.95576" cy="18.3436" rx="0.510501" ry="0.526261"
                                 transform="rotate(-2.27501 6.95576 18.3436)" fill="black"/>
                        <ellipse id="particle-8" cx="17.7925" cy="15.9117" rx="0.408401" ry="0.421009"
                                 transform="rotate(-2.27501 17.7925 15.9117)" fill="black"/>
                        <ellipse id="particle-7" cx="17.1946" cy="13.7234" rx="0.918902" ry="0.94727"
                                 transform="rotate(-2.27501 17.1946 13.7234)" fill="black"/>
                        <ellipse id="particle-6" cx="15.1257" cy="18.2297" rx="1.9399" ry="1.99979"
                                 transform="rotate(-2.27501 15.1257 18.2297)" fill="black"/>
                        <ellipse id="particle-5" cx="5.1706" cy="11.9891" rx="1.4294" ry="1.47353"
                                 transform="rotate(-2.27501 5.1706 11.9891)" fill="black"/>
                        <ellipse id="particle-4" cx="5.65494" cy="6.17638" rx="0.714701" ry="0.736765"
                                 transform="rotate(-2.27501 5.65494 6.17638)" fill="black"/>
                        <ellipse id="particle-3" cx="5.16711" cy="17.0453" rx="0.816801" ry="0.842018"
                                 transform="rotate(-2.27501 5.16711 17.0453)" fill="black"/>
                        <ellipse id="particle-2" cx="17.4415" cy="7.07749" rx="1.4294" ry="1.47353"
                                 transform="rotate(-2.27501 17.4415 7.07749)" fill="black"/>
                        <ellipse id="particle-1" cx="11.0662" cy="6.06674" rx="1.4294" ry="1.47353"
                                 transform="rotate(-2.27501 11.0662 6.06674)" fill="black"/>
                    </g>
                </g>
            </svg>
        </div>

        <span class="cursor-circle" v-for="n in 20" :key="n"></span>
    </div>
</template>

<script lang="ts" setup>
import {onMounted} from 'vue'

// Global object to store the current mouse position
const coords = {x: 0, y: 0}

// References to the DOM elements for animated effects
let circles: NodeListOf<HTMLDivElement>


// Setup function that runs after component mounts
onMounted(() => {
    // Select all DOM elements related to cursor animation
    circles = document.querySelectorAll<HTMLDivElement>('.cursor-circle')

    // Initialize all trail circles with starting coordinates
    circles.forEach(circle => {
        ;(circle as any).x = 0
        ;(circle as any).y = 0
    })

    // Track mouse movement and update the shared coordinates
    window.addEventListener('mousemove', (e) => {
        coords.x = e.clientX
        coords.y = e.clientY
    })



    let pressStartTime = 0 // To store when the mouse was pressed

    // On mouse click, animate the last circle and reset particles
    window.addEventListener('mousedown', () => {
        pressStartTime = Date.now() // Record time of press

        // Add visual "click" effect to the final circle in the trail
        circles[circles.length - 1].classList.add('clicked')
        circles[0].classList.add('animate')
    })

    // Remove click effect shortly after mouse release
    window.addEventListener('mouseup', () => {
        const pressDuration = Date.now() - pressStartTime
        const animatedCircle = circles[0]
        const svg = animatedCircle.querySelector('svg')
        const particles = svg?.querySelector('#particles')

        // Always remove "clicked" circle effect
        setTimeout(() => {
            circles[circles.length - 1].classList.remove('clicked')
        }, 200)

        const removeAnimate = () => {
            animatedCircle.classList.remove('animate')
            animatedCircle.classList.remove('hide-doodle')
        }

        if (pressDuration < 2000) {
            // First add hide-doodle, then remove animate after animation
            animatedCircle.classList.add('hide-doodle')

            // Remove animate after the hide-doodle animation finishes (700ms)
            setTimeout(removeAnimate, 700)
        } else if (particles) {
            const onAnimationEnd = (e: Event) => {
                if (!(e instanceof AnimationEvent)) return;
                if (e.animationName === 'cursor-particles-animation') {
                    particles.removeEventListener('animationend', onAnimationEnd)

                    animatedCircle.classList.add('hide-doodle')
                    setTimeout(removeAnimate, 700)
                }
            }

            particles.addEventListener('animationend', onAnimationEnd)
        }
    })


    // Start both animations
    animateCircles()
})

/**
 * Animate trailing circles that follow the cursor,
 * creating a smooth snake-like motion.
 */
function animateCircles() {
    // Start at the cursor position
    let x = coords.x
    let y = coords.y

    circles.forEach((circle, index) => {
        // Move this circle to current position
        circle.style.left = `${x - 10}px` // Centering a 20x20px circle
        circle.style.top = `${y - 10}px`

        // Set scale based on order: creates trailing size effect
        circle.style.transform = `scale(${(circles.length - index) / circles.length})`

        // Save the circle’s position for the next one to follow
        ;(circle as any).x = x
        ;(circle as any).y = y

        // Move toward the next circle’s position for smoothing
        const nextCircle = circles[index + 1] || circles[0]
        x += ((nextCircle as any).x - x) * 0.3
        y += ((nextCircle as any).y - y) * 0.3
    })

    // Schedule the next animation frame
    requestAnimationFrame(animateCircles)
}
</script>

<style lang="scss">
// Cursor animation styles
.cursor {
    pointer-events: none;
    position: fixed;
    display: block;
    border-radius: 0;
    mix-blend-mode: difference;
    top: 0;
    left: 0;
    z-index: 1000;
}

.cursor-circle {
    position: absolute;
    display: block;
    width: 24px;
    height: 24px;

    svg {
        display: none;
        transform: scale(3.5);

        g {
            fill: none !important;
            transform-origin: center;
        }

        path, ellipse {
            fill: #fff !important;
            transform-origin: center;
            stroke: none !important;
        }

        #particles {
            scale: 0;
            animation:
                cursor-particles-animation 5200ms ease-out 2000ms,
                cursor-doodle-spin 3000ms linear infinite;
        }
    }

    &.animate svg {
        display: block;
        animation: doodle-scale 700ms linear;

        #small-doodle {
            animation: cursor-doodle-spin infinite linear 10000ms;
            animation-direction: normal;
        }

        #big-doodle {
            animation: cursor-doodle-spin infinite linear 4000ms;
            animation-direction: reverse;
        }
    }

    &.hide-doodle svg {
        animation: doodle-scale-out 700ms linear;
    }
}

span.cursor-circle {
    border-radius: 100%;
    background-color: #fff;

    &.clicked {
        transform: scale(1.6) !important;
        border: 0.5px solid #fff;
        background: transparent !important;
    }
}

// Cursor animation styles for the dark theme
body[data-theme="dark"] {
    span.cursor-circle {
        background-color: #fff;

        &:last-child {
            border: 0.5px solid #fff;
        }
    }
}


@keyframes cursor-doodle-spin {
    from {
        rotate: 0deg;
    }
    to {
        rotate: 360deg;
    }
}

@keyframes doodle-scale {
    from {
        transform: scale(1);
    }
    to {
        transform: scale(3.5);
    }
}

@keyframes doodle-scale-out {
    from {
        transform: scale(3.5);
    }
    to {
        transform: scale(1);
    }
}

@keyframes cursor-particles-animation {
    0% {
        scale: 0;
    }
    20% {
        scale: 1;
    }
    80% {
        scale: 1;
    }
    100% {
        scale: 0;
    }
}
</style>